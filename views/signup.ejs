<% include header %>
<% include recaptchaOptions %>
<form action="/users/create" method="post" class="form-horizontal">
  <legend>Create your personal account</legend>
  <div class="control-group">
    <input id="username" name="username" type="text" placeholder="Username" autofocus="autofocus" autocomplete="off" tabindex="1" value="<% if(values.username) { %> <%=values.username %> <% }%>">
    <span id="username-help" class="help-text help-error"><% if(errors) { %> <%=errors.username %> <% }%></span>
  </div>
  <div class="control-group">
    <input id="email" name="email" type="text" placeholder="Email" tabindex="2" value="<% if(values.email) { %> <%=values.email %> <% }%>">
    <span id="email-help" class="help-text help-error"><% if(errors) { %> <%=errors.email %> <% }%></span>
  </div>
  <div class="control-group">
    <input id="password" name="password" type="password" placeholder="Password" tabindex="3" value="<% if(values.password) { %> <%=values.password %> <% }%>">
    <span id="password-help" class="help-text help-error"><% if(errors) { %> <%=errors.password %> <% }%></span>
  </div>
  <% include recaptcha %>
  <button id="submit" type="submit" class="btn btn-primary disabled" disabled="disabled" tabindex="5">Create an account</button>
</form>
<script type="text/javascript">

    var setHelpText = function(id, text, type) {
      $(id).attr('class', 'help-text help-' + type).html(text);
      setSubmitStatus();
    };

    var setSubmitStatus = function() {
      var newClass = 'btn btn-primary disabled';
      var disabled = 'disabled';

      if($('#username-help').hasClass('help-ok') && $('#email-help').hasClass('help-ok')) {
        $('#submit').attr('class', 'btn btn-primary').removeAttr('disabled');
      } else {
        $('#submit').attr('class', 'btn btn-primary disabled').attr('disabled', disabled);
      }
    };

    var check = function (id, url) {
      var inputField = $('#' + id)[0];
      if (inputField.value && inputField.value != inputField.lastValue) {
        setHelpText('#' + id + '-help', 'Checking...', 'warning');

        if (inputField.timer) clearTimeout(inputField.timer);
        inputField.timer = setTimeout(function () {
          $.ajax({
            url: url + inputField.value,
            type: 'post',
            success: function (jqr) {
              setHelpText('#' + id + '-help', jqr, 'ok');
            },
            error: function(jqr) {
              setHelpText('#' + id + '-help', jqr.responseText, 'error');
            }
          });
        }, 200);

        inputField.lastValue = inputField.value;
      }
    };

    var checkUsername = function() {
      check('username', '/users/validate/username?value=');
    }

    var checkEmail = function() {
      check('email', '/users/validate/email?value=');
    }

    var bindChecker = function(id, checker) {
      $(id).keyup(checker);
      checker();
    }

    $(document).ready(function () {
      bindChecker('#username', checkUsername);
      bindChecker('#email', checkEmail);
    });
</script>
<% include footer %>